<div class="container mt-4">

  <!-- Create Group Section -->
  <div class="card shadow-sm mb-4" *ngIf="currentUser.role === 'SUPER_ADMIN' || currentUser.role === 'GROUP_ADMIN'">
    <div class="card-body">
      <h4 class="card-title mb-3">Create a New Group</h4>
      <div class="input-group">
        <input type="text" class="form-control" placeholder="Enter group name" [(ngModel)]="newGroupName">
        <button class="btn btn-success" (click)="createGroup()" [disabled]="!newGroupName.trim()">
          <i class="bi bi-plus-circle"></i> Create Group
        </button>
      </div>
    </div>
  </div>

  <!-- Message when no groups are assigned -->
  <div *ngIf="visibleGroups.length === 0" class="alert alert-warning text-center">
    <i class="bi bi-exclamation-triangle"></i> You are not assigned to any groups.
  </div>

  <!-- Groups List -->
  <div class="row" *ngIf="visibleGroups.length > 0">
    <div class="col-md-4 mb-3" *ngFor="let group of visibleGroups">
      <div class="card h-100 border-0 shadow-sm position-relative">

        <!-- Dropdown Menu (top right) -->
        <div class="dropdown position-absolute top-0 end-0 m-2" *ngIf="canEdit(group)">
          <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-three-dots-vertical"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" (click)="editGroup(group)">
                <i class="bi bi-pencil"></i> Edit
              </a>
            </li>
            <li>
              <a class="dropdown-item text-danger" (click)="removeGroup(group.id)">
                <i class="bi bi-trash"></i> Delete
              </a>
            </li>
          </ul>
        </div>

        <!-- Card Body -->
        <div class="card-body d-flex flex-column">
          <h5 class="card-title fw-bold">{{ group.name }}</h5>

          <!-- Admins -->
          <p class="card-text mb-2">
            <strong>Admins:</strong>
            <span *ngFor="let admin of group.groupAdmins; let i = index">
              {{ getUsernameById(admin) }}<span *ngIf="i < group.groupAdmins.length - 1">, </span>
            </span>
          </p>

          <!-- Members -->
          <p class="card-text mb-3">
            <strong>Members:</strong>
            <span *ngFor="let member of group.members; let i = index">
              {{ getUsernameById(member) }}<span *ngIf="i < group.members.length - 1">, </span>
            </span>
          </p>

          <!-- Big Channel Button -->
          <a class="btn btn-success btn-lg w-100 mb-2"
             [routerLink]="['/groups', group.id, 'channels']">
            <i class="bi bi-chat-dots"></i> View Channels
          </a>

          <!-- Leave Group Button -->
          <button class="btn btn-outline-warning btn-sm w-100"
                  *ngIf="group.members.includes(currentUser.id) && currentUser.role !== 'SUPER_ADMIN'"
                  (click)="leaveGroup(group.id)">
            <i class="bi bi-box-arrow-right"></i> Leave Group
          </button>
          
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Group Panel -->
  <div *ngIf="selectedGroup" class="card shadow-sm mt-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="card-title mb-0">Manage {{ selectedGroup.name }}</h4>
        <!-- Close button -->
        <button class="btn btn-sm btn-outline-secondary" (click)="selectedGroup = null">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <!-- Make Group Admin -->
      <div class="mb-4">
        <h6 class="fw-bold">Promote Member to Group Admin</h6>
        <div class="input-group">
          <select class="form-select" [(ngModel)]="selectedNewAdmin">
            <option *ngFor="let member of selectedGroup.members"
                    [value]="member"
                    [disabled]="selectedGroup.groupAdmins.includes(member)">
              {{ getUsernameById(member) }}
            </option>
          </select>
          <button class="btn btn-warning"
                  (click)="makeGroupAdmin()"
                  [disabled]="!selectedNewAdmin || !canEdit(selectedGroup)">
            <i class="bi bi-shield-lock"></i> Promote
          </button>
        </div>
        <small *ngIf="!canEdit(selectedGroup)" class="text-danger">
          Only a group admin or super admin can promote members.
        </small>
      </div>

      <!-- Remove Member -->
      <div class="mb-4">
        <h6 class="fw-bold">Remove Member</h6>
        <div class="input-group">
          <select class="form-select" [(ngModel)]="selectedMember">
            <option *ngFor="let member of selectedGroup.members" [value]="member">
              {{ getUsernameById(member) }}
            </option>
          </select>
          <button class="btn btn-danger"
                  (click)="removeMember()"
                  [disabled]="!selectedMember || !canEdit(selectedGroup)">
            <i class="bi bi-person-dash"></i> Remove
          </button>
        </div>
        <small *ngIf="!canEdit(selectedGroup)" class="text-danger">
          Only a group admin or super admin can remove members.
        </small>
      </div>

      <!-- Add Member -->
      <div>
        <h6 class="fw-bold">Add Member</h6>
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Enter member ID" [(ngModel)]="newMember">
          <button class="btn btn-success" (click)="addMember()" [disabled]="!newMember.trim()">
            <i class="bi bi-person-plus"></i> Add
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
