<div class="container mt-4" *ngIf="currentUser">

  <!-- Create Group Section (SUPER_ADMIN only) -->
  <div class="card shadow-sm mb-4" *ngIf="currentUser.roles.includes('SUPER_ADMIN')">
    <div class="card-body">
      <h4 class="card-title mb-3">Create a New Group</h4>
      <div class="input-group">
        <input type="text" class="form-control" placeholder="Enter group name" [(ngModel)]="newGroupName">
        <button class="btn btn-success" (click)="createGroup()" [disabled]="!newGroupName.trim()">Create Group</button>
      </div>
    </div>
  </div>

  <!-- Groups List -->
  <div class="row" *ngIf="groups.length; else noGroups">
    <div class="col-md-4 mb-3" *ngFor="let group of groups">
      <div class="card h-100 shadow-sm group-card" (click)="goToGroupChannels(group._id)">
        <div class="card-body">
          <h5 class="card-title">{{ group.name }}</h5>

          <p><strong>Admins:</strong>
            <span *ngFor="let admin of group.groupAdmins; let i = index">
              {{ getUsernameById(admin) }}<span *ngIf="i < group.groupAdmins.length - 1">, </span>
            </span>
          </p>

          <p><strong>Members:</strong>
            <span *ngFor="let member of group.members; let i = index">
              {{ getUsernameById(member) }}<span *ngIf="i < group.members.length - 1">, </span>
            </span>
          </p>

          <!-- Leave Group button for normal members -->
          <button class="btn btn-outline-warning btn-sm w-100 mb-2" 
                  *ngIf="group.members.includes(currentUser._id) && !isAdmin(group) && !currentUser.roles.includes('SUPER_ADMIN')"
                  (click)="removeMemberFromGroup(group, currentUser._id); $event.stopPropagation()">
            Leave Group
          </button>

          <!-- Edit Group button for Admins -->
          <button class="btn btn-outline-primary btn-sm w-100" 
                  *ngIf="isAdmin(group)"
                  (click)="editGroup(group); $event.stopPropagation()">
            Edit Group
          </button>

        </div>
      </div>
    </div>
  </div>

  <ng-template #noGroups>
    <div class="alert alert-warning text-center">No groups found.</div>
  </ng-template>

  <!-- Edit Group Modal/Section -->
  <div class="card shadow-sm mt-4" *ngIf="selectedGroup">
    <div class="card-body">
      <h4 class="card-title mb-3">Edit Group: {{ selectedGroup.name }}</h4>

      <!-- Add Member -->
      <div class="input-group mb-2">
        <select class="form-select" [(ngModel)]="newMember">
          <option value="" disabled selected>Select member to add</option>
          <option *ngFor="let user of users" [value]="user._id" [disabled]="selectedGroup.members.includes(user._id)">
            {{ user.username }}
          </option>
        </select>
        <button class="btn btn-success" (click)="addMemberToGroup(selectedGroup, newMember)" [disabled]="!newMember">Add Member</button>
      </div>

      <!-- Make Admin -->
      <div class="input-group mb-2">
        <select class="form-select" [(ngModel)]="selectedNewAdmin">
          <option value="" disabled selected>Select member to make admin</option>
          <option *ngFor="let memberId of selectedGroup.members" [value]="memberId" [disabled]="selectedGroup.groupAdmins.includes(memberId)">
            {{ getUsernameById(memberId) }}
          </option>
        </select>
        <button class="btn btn-warning" (click)="makeGroupAdmin(selectedGroup, selectedNewAdmin)" [disabled]="!selectedNewAdmin">Make Admin</button>
      </div>

      <!-- Remove Members -->
      <p><strong>Current Members:</strong></p>
      <ul class="list-group mb-2">
        <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let memberId of selectedGroup.members">
          {{ getUsernameById(memberId) }}
          <button class="btn btn-sm btn-danger" *ngIf="memberId !== currentUser._id" (click)="removeMemberFromGroup(selectedGroup, memberId)">Remove</button>
        </li>
      </ul>

      <button class="btn btn-secondary" (click)="selectedGroup = null">Close</button>
    </div>
  </div>

</div>
